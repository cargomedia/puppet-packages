mysql -e 'update mysql.user set password=PASSWORD("<%= @dbPassword %>") where user="<%= @dbUser %>"; flush privileges;'

chown www-data: /etc/cacti/id_rsa
chmod 600 /etc/cacti/id_rsa

if ! (test -e /etc/apache2/ssl/cacti.pem); then
	mkdir -p /etc/apache2/ssl
	openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout /etc/apache2/ssl/cacti.pem -out /etc/apache2/ssl/cacti.pem -subj '/CN=cacti.<%= @domain %>'
	a2enmod ssl
	apache2ctl restart
fi

# Fix cli tools
if ! (test -e /usr/share/cacti/lib); then
	ln -s /usr/share/cacti/site/lib /usr/share/cacti/lib
fi
if ! (test -e /usr/share/cacti/include); then
	ln -s /usr/share/cacti/site/include /usr/share/cacti/include
fi
sed -i 's#^include_once("../lib/import.php");$#include_once(dirname(__FILE__)."/../lib/import.php");#' /usr/share/cacti/cli/import_template.php

# Percona templates
PERCONA_VERSION='1.1.8'
if ! (grep -q 'version = "${PERCONA_VERSION}"' /usr/share/cacti/site/scripts/ss_get_mysql_stats.php && grep -q "version = '${PERCONA_VERSION}'" /usr/share/cacti/site/scripts/ss_get_by_ssh.php); then
	wget -q http://mysql-cacti-templates.googlecode.com/files/better-cacti-templates-${PERCONA_VERSION}.tar.gz
	unp better-cacti-templates-${PERCONA_VERSION}.tar.gz
	cd better-cacti-templates-${PERCONA_VERSION}
	cp scripts/ss_get_by_ssh.php /usr/share/cacti/site/scripts/
	cp scripts/ss_get_mysql_stats.php /usr/share/cacti/site/scripts/
	cp templates/*.xml /usr/share/cacti/templates-cargomedia/
fi

# Change apache template port to 8080
sed -i 's#ss_get_by_ssh.php --host &lt;hostname&gt; --type apache#ss_get_by_ssh.php --host \&lt;hostname\&gt; --port2 8080 --type apache#' /usr/share/cacti/templates-cargomedia/cacti_host_template_x_apache_server*.xml

# Import templates
find /usr/share/cacti/templates-cargomedia -iname '*.xml' -exec php /usr/share/cacti/cli/import_template.php --filename={} \;
